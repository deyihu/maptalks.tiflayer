/*!
 * maptalks.tiflayer v0.1.0
  */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks"),require("geotiff")):"function"==typeof define&&define.amd?define(["exports","maptalks","geotiff"],e):e((t=t||self).maptalks=t.maptalks||{},t.maptalks,t.GeoTIFF)}(this,(function(t,e,i){"use strict";var n=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t,e){var i=function(){var t={},e=Math.PI/180,i=180/Math.PI,n=6378137,o=20037508.342789244;function a(t){return Number(t)===t&&t%1!=0}function r(e){if(e=e||{},this.size=e.size||256,this.expansion=!0===e.antimeridian?2:1,!t[this.size]){var i=this.size,n=t[this.size]={};n.Bc=[],n.Cc=[],n.zc=[],n.Ac=[];for(var o=0;o<30;o++)n.Bc.push(i/360),n.Cc.push(i/(2*Math.PI)),n.zc.push(i/2),n.Ac.push(i),i*=2}this.Bc=t[this.size].Bc,this.Cc=t[this.size].Cc,this.zc=t[this.size].zc,this.Ac=t[this.size].Ac}return r.prototype.px=function(t,i){if(a(i)){var n=this.size*Math.pow(2,i),o=n/2,r=n/360,s=n/(2*Math.PI),h=n,f=Math.min(Math.max(Math.sin(e*t[1]),-.9999),.9999),c=o+t[0]*r,l=o+.5*Math.log((1+f)/(1-f))*-s;return c>h*this.expansion&&(c=h*this.expansion),l>h&&(l=h),[c,l]}o=this.zc[i],f=Math.min(Math.max(Math.sin(e*t[1]),-.9999),.9999),c=Math.round(o+t[0]*this.Bc[i]),l=Math.round(o+.5*Math.log((1+f)/(1-f))*-this.Cc[i]);return c>this.Ac[i]*this.expansion&&(c=this.Ac[i]*this.expansion),l>this.Ac[i]&&(l=this.Ac[i]),[c,l]},r.prototype.ll=function(t,e){if(a(e)){var n=this.size*Math.pow(2,e),o=n/360,r=n/(2*Math.PI),s=n/2,h=(t[1]-s)/-r;return[(t[0]-s)/o,i*(2*Math.atan(Math.exp(h))-.5*Math.PI)]}h=(t[1]-this.zc[e])/-this.Cc[e];return[(t[0]-this.zc[e])/this.Bc[e],i*(2*Math.atan(Math.exp(h))-.5*Math.PI)]},r.prototype.bbox=function(t,e,i,n,o){n&&(e=Math.pow(2,i)-1-e);var a=[t*this.size,(+e+1)*this.size],r=[(+t+1)*this.size,e*this.size],s=this.ll(a,i).concat(this.ll(r,i));return"900913"===o?this.convert(s,"900913"):s},r.prototype.xyz=function(t,e,i,n){"900913"===n&&(t=this.convert(t,"WGS84"));var o=[t[0],t[1]],a=[t[2],t[3]],r=this.px(o,e),s=this.px(a,e),h=[Math.floor(r[0]/this.size),Math.floor((s[0]-1)/this.size)],f=[Math.floor(s[1]/this.size),Math.floor((r[1]-1)/this.size)],c={minX:Math.min.apply(Math,h)<0?0:Math.min.apply(Math,h),minY:Math.min.apply(Math,f)<0?0:Math.min.apply(Math,f),maxX:Math.max.apply(Math,h),maxY:Math.max.apply(Math,f)};if(i){var l={minY:Math.pow(2,e)-1-c.maxY,maxY:Math.pow(2,e)-1-c.minY};c.minY=l.minY,c.maxY=l.maxY}return c},r.prototype.convert=function(t,e){return"900913"===e?this.forward(t.slice(0,2)).concat(this.forward(t.slice(2,4))):this.inverse(t.slice(0,2)).concat(this.inverse(t.slice(2,4)))},r.prototype.forward=function(t){var i=[n*t[0]*e,n*Math.log(Math.tan(.25*Math.PI+.5*t[1]*e))];return i[0]>o&&(i[0]=o),i[0]<-o&&(i[0]=-o),i[1]>o&&(i[1]=o),i[1]<-o&&(i[1]=-o),i},r.prototype.inverse=function(t){return[t[0]*i/n,(.5*Math.PI-2*Math.atan(Math.exp(-t[1]/n)))*i]},r}();t.exports=i}));const o=new n({size:256,antimeridian:!0}),a=new i.Pool,r=[1,1,1,1],s=[1,1,1,1],h=256;let f,c;const l="_tifprocess_";let d,g;function u(t,i){let n;return e.Browser.decodeImageInWorker?n=new OffscreenCanvas(t,i):(n=document.createElement("canvas"),n.width=t,n.height=i),n}e.registerWorkerAdapter(l,(function(t,e){function i(t,e,i){const n=function(t,e){return new OffscreenCanvas(t,e)}(t,e),o=n.getContext("2d"),a=o.createImageData(n.width,n.height);let r=0;for(let t=0,e=i.length;t<e;t+=3){const e=i[t],n=i[t+1],o=i[t+2];a.data[r]=e,a.data[r+1]=n,a.data[r+2]=o;let s=255;0===e&&0===n&&0===o&&(s=0),a.data[r+3]=s,r+=4}return o.putImageData(a,0,0),n.transferToImageBitmap()}t.initialize=function(){},t.onmessage=function(t,e){const n=t.data,{type:o}=n,{width:a,height:r,buffer:s}=n;if("createimage"===o){const t=i(a,r,new Uint8Array(s));e(null,{loaded:!0,buffer:t},[t])}}}));const p=(t,e,i)=>{let n=1/0,a=1/0,r=-1/0,s=-1/0;return t.toArray().forEach((t=>{t=t.toArray(),t=o[e](t);const[i,h]=t;n=Math.min(n,i),a=Math.min(a,h),r=Math.max(r,i),s=Math.max(s,h)})),i?(i.xmin=n,i.ymin=a,i.xmax=r,i.ymax=s,i):[n,a,r,s]};class m extends e.TileLayer{constructor(t,e){super(t,e),this._pendingTiles=[],this.on("renderercreate",this._renderCreate),this.geoTifInfo={loaded:!1},this._initTif()}_renderCreate(t){t.renderer.loadTile=function(t){let i;if(e.Browser.decodeImageInWorker)i={};else{const e=this.layer.getTileSize(t.layer);i=new Image,i.width=e.width,i.height=e.height,i.onload=this.onTileLoad.bind(this,i,t),i.onerror=this.onTileError.bind(this,i,t)}return this.loadTileImage(i,t.url,t),i},t.renderer.loadTileImage=(t,e,i)=>{if(!this.geoTifInfo.loaded)return this._pendingTiles.push({img:t,url:e,tile:i}),this;setTimeout((()=>{this._getTifTile({url:e,img:t,tile:i})}),1)}}_getTifTile(t){const{url:i,img:n,tile:o}=t,a=new URL(e.Util.getAbsoluteURL(i)).searchParams;function l(t){return parseInt(a.get(t))}const d=t=>{n instanceof Image?n.src=t:this.getRenderer().onTileLoad(t,o)},p=l("x"),m=l("y"),T=l("z"),x=this._getTileExtent(p,m,T),I=this.getMap().getProjection();let M;if(I.code.indexOf("4326")>-1?M=this.geoTifInfo.bounds:I.code.indexOf("3857")>-1&&(M=this.geoTifInfo.mBounds),!M)return void console.error("onlay support 4326/3857 prj");if(r[0]=x.xmin,r[1]=x.ymin,r[2]=x.xmax,r[3]=x.ymax,s[0]=M[0],s[1]=M[1],s[2]=M[2],s[3]=M[3],w=s,(y=r)[2]<w[0]||y[1]>w[3]||y[0]>w[2]||y[3]<w[1]){return d(function(){if(c||(c=u(h,h)),e.Browser.decodeImageInWorker)return c.getContext("2d"),c.transferToImageBitmap();return f||(f=c.toDataURL("image/png",.5)),f}()),null}var y,w;const z=function(t){g||(g=u(h,h));const i=g.getContext("2d"),{width:n,height:o}=g;i.clearRect(0,0,n,o);const{bounds:a,image:r,quality:s}=t,[f,c,l,d]=a;if(i.drawImage(r,f,c,l,d,0,0,n,o),e.Browser.decodeImageInWorker)return g.transferToImageBitmap();return g.toDataURL("image/png",s||.6)}({bounds:this.getImageBounds(p,m,T,M),image:this.geoTifInfo.canvas,quality:this.options.quality});d(z)}_tifLoaded(){return this._pendingTiles.forEach((t=>{this._getTifTile(t)})),this}_initTif(){const t=this.options.tifUrl;if(!t)return this;this.geoTifInfo={url:t,loaded:!1},fetch(t).then((t=>t.arrayBuffer())).then((t=>{i.fromArrayBuffer(t).then((t=>t.getImage())).then((t=>{const i=t.getWidth(),n=t.getHeight();let o=t.getBoundingBox(),a=o;const r=t.getGeoKeys();this.geoTifInfo.geoInfo=r;const s=new e.Extent(o);r&&4326===r.GeographicTypeGeoKey&&(a=p(s,"forward")),r&&3857===r.ProjectedCSTypeGeoKey&&(o=p(s,"inverse"),p(s,"inverse",s)),this.geoTifInfo=Object.assign(this.geoTifInfo,{width:i,height:n,bounds:o,extent:s,mBounds:a}),this.readTif(t)}))})).catch((t=>{console.log(t)}))}readTif(t){const i=t.getWidth(),n=t.getHeight(),o=Math.ceil(n/400),r=[];let s=0;const h=()=>{if(s<o){if(this.options.datadebug&&console.log(`正在读取(by geotiff.readRGB) tif的数据 ${s+1}/${o}`),!this.geoTifInfo.bounds)return;const e=400*s,f=Math.min(e+400,n);t.readRGB({interleave:!0,window:[0,e,i,f],pool:a}).then((t=>{r.push(t),s++,h()}))}else{if(!this.geoTifInfo.bounds)return;if(this.geoTifInfo.data=function(t){let e=0;const i=t.length;for(let n=0;n<i;n++)e+=t[n].length;const n=new Uint8Array(e);let o=0;for(let e=0;e<i;e++)n.set(t[e],o),o+=t[e].length;return n}(r),e.Browser.decodeImageInWorker){const t=d||(d=new e.worker.Actor(l),d),o=this.geoTifInfo.data.buffer;t.send({width:i,height:n,type:"createimage",url:this.geoTifInfo.url,buffer:o},[o],((t,e)=>{t?console.error(t):(this.geoTifInfo.loaded=e.loaded,this.geoTifInfo.canvas=e.buffer,this.fire("tifload",Object.assign({},this.geoTifInfo)),this._tifLoaded())}))}else this.geoTifInfo.canvas=function(t,e,i){const n=u(t,e),o=n.getContext("2d"),a=o.createImageData(n.width,n.height);let r=0;for(let t=0,e=i.length;t<e;t+=3){const e=i[t],n=i[t+1],o=i[t+2];a.data[r]=e,a.data[r+1]=n,a.data[r+2]=o;let s=255;0===e&&0===n&&0===o&&(s=0),a.data[r+3]=s,r+=4}return o.putImageData(a,0,0),n}(i,n,this.geoTifInfo.data),this.geoTifInfo.loaded=!0,this.fire("tifload",Object.assign({},this.geoTifInfo)),this._tifLoaded()}};h()}getImageBounds(t,e,i,n){const o=this._getTileExtent(t,e,i),a=o.xmin,r=o.ymin,s=o.xmax,h=o.ymax,{width:f,height:c}=this.geoTifInfo,[l,d,g,u]=n,p=f/(g-l),m=c/(u-d);return[(a-l)*p,c-(h-d)*m,(s-a)*p,(h-r)*m].map((t=>Math.round(t)))}_getTileExtent(t,e,i){const n=this.getMap()._getResolution(i);return this._getTileConfig().getTilePrjExtent(t,e,n)}setTifUrl(t){return this.options.tifUrl=t,this.geoTifInfo={},this._pendingTiles=[],this._initTif(),this.getRenderer().clear(),this.getRenderer().setToRedraw(),this}}m.mergeOptions({urlTemplate:"./hello?x={x}&y={y}&z={z}",datadebug:!1,quality:.6}),t.TifLayer=m,Object.defineProperty(t,"__esModule",{value:!0})}));
